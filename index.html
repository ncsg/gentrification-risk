<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
       "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>NCSG Gentrification Risk Maps</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

<style>
	
html, body, #map {
	width: 100%;
	height: 100%;
	padding: 0;
	margin: 0;
	font-family: 'Open Sans', sans-serif;
}
#topBanner {
	height: 80px;
	background-color: #fff;
	margin: 0;
	padding: 10px;
	padding-left: 50px;
	padding-top: 25px;
	font-family: 'Open Sans', sans-serif;
	font-size: 22px;
	font-weight: 600;
}
#topBanner img {
	float: left;
	margin-top: -14px;
	padding-right: 15px;
}
#mapContainer {
	border-top: 1px solid #ccc;
	border-bottom: 1px solid #ccc;
	margin-left: 0;
	margin-right: 0;
	width: 100%;
	height: 570px;
	padding: 0;
}

/* overrides default style for legends */
#map .cartodb-legend-stack .cartodb-legend .legend-title {
	font-family: 'Open Sans', sans-serif;
	color: black;
	font-size: 12px;
	font-weight: bold;
	text-transform: none;
}
#map .cartodb-legend-stack .cartodb-legend li {
	font-family: 'Open Sans', sans-serif;
	color: black;
	font-size: 12px;
	font-weight: normal;
	text-transform: none;
}
#map .cartodb-legend-stack .cartodb-legend li .bullet {
	height: 10px;
	width: 10px;
}
#map div.cartodb-legend-stack div.cartodb-legend li.min {
	float: left;
	width: 20%;
	text-align: center;
}
#map div.cartodb-legend-stack div.cartodb-legend li.median {
	float: left;
	width: 60%;
	text-align: center;
}
#map div.cartodb-legend-stack div.cartodb-legend li.max {
	float: right;
	width: 20%;
	text-align: center;
}

/* overrides default style for tooltips */
#map .cartodb-tooltip-content {
	padding: 6px;
}
#map .cartodb-tooltip-content p {
	font-family: 'Open Sans', sans-serif;
	font-size: 11px;
}
#map .cartodb-searchbox .text {
	font-family: 'Open Sans', sans-serif;
	font-size: 12px;
}

/* add scrolling to bootstrap menus */
.scrollable-menu {
    height: auto;
    max-height: 450px;
    overflow-x: hidden;
}

#layerSelectionContainer {
	position: absolute;
	top: 100px;
	left: 90px;
	padding: 0px;
	font-size: 12px;
}
#geoSelectionContainer {
	position: absolute;
	top: 140px;
	left: 90px;
	padding: 0px;
	font-size: 12px;
}

#textContent {
	width: 80%;
	padding-top: 30px; 
	margin-left: auto;
	margin-right: auto;
	font-family: 'Open Sans', sans-serif;
	font-size: 16px;
}
#textContent h3 {
	font-size: 20px;
	font-weight: 600;
	margin-bottom: 18px;
}
#textContent h4 {
	font-size: 16px;
	font-weight: 600;
	margin-bottom: 12px;
}
#textContent li {
	margin-top: 6px;
}
#textContent .smaller {
	font-size: 14px;
}
#textContent .larger {
	font-size: 18px;
}
#textContent .larger li {
	margin-top: 12px;
}
.figure {
	float: right;
	margin: 20px;
	margin-top: 0px;
	margin-right: -50px;
	padding: 0px;
	width: 400px;
	border: 1px solid #ccc;
	border-right: 0px;
}

@media only screen 
and (max-width: 380px) {
	
	.mobile-hide {
		display: none;
	}
	#topBanner {
		padding-left: 20px;
		padding-top: 5px;
		font-size: 16px;
		font-weight: bold;
	}
	#topBanner img {
		margin-top: 0;
	}
	#mapContainer {
		height: 320px;
		margin-bottom: 55px;
	}
	div .cartodb-legend-stack {
		visibility: hidden;
	}
	#layerSelectionContainer {
		left: 20px;
		top: 410px;
	}
	#geoSelectionContainer {
		left: 20px;
		top: 450px;
	}
}

</style>

<!-- load code libraries -->
<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
<script src="lib/jquery.min.js"></script>
<link rel="stylesheet" href="lib/bootstrap.css">
<script src="lib/bootstrap.js"></script>
<link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700'>

</head>

<body>
	
<div id="topBanner">
	<a href='ncsg.github.io/plcc-dashboard'><img src='ncsg_knocked.jpg' height='60'></a> NCSG Gentrification Risk Maps</div>
	
<div id="mapContainer"></div>

<div id ="layerSelectionContainer">
<div class="dropdown">
<!-- this button style is from the Bootstrap library -->
  <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    Choose another data series...
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu scrollable-menu" id="layer-selector" aria-labelledby="dropdownMenuDivider">
	  
    <li data-url="https://nfinio.cartodb.com/api/v2/viz/012897fc-e6d8-11e5-83e5-0e674067d321/viz.json" class="active">
    <a href="#">Displacement typologies</a></li>
    
    <li role="separator" class="divider"></li>

    <li data-url="https://cci-displacement.cartodb.com/api/v2/viz/787c6988-47bd-11e5-8eca-0e853d047bba/viz.json">
    <a href="#">Basemap only</a></li>
    
    <li data-url="https://cci-displacement.cartodb.com/api/v2/viz/3949b4a2-31a4-11e5-aeae-0e9d821ea90d/viz.json">
    <a href="#">Population (2013)</a></li>
    
    <li data-url="https://cci-displacement.cartodb.com/api/v2/viz/2b46eec6-31c5-11e5-b5ff-0e0c41326911/viz.json">
    <a href="#">Housing units in pre-1950 buildings (%, 2013)</a></li>

    
  </ul>
</div>
</div>

<div id ="geoSelectionContainer">
<div class="dropdown">
<!-- this button style is from the Bootstrap library -->
  <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    Limit by city or county...
      
<!-- these wont work until Nick enters the georeferencing info on his map,  -->
      
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu scrollable-menu" id="geo-selector" aria-labelledby="dropdownMenuDivider">
    <li data-geo="all" class="active"><a href="#">SHOW ALL</a></li>   
    <li role="separator" class="divider"></li>
    <li data-geo="county" data-value="Montgomery"><a href="#">Montgomery County</a></li>
    <li data-geo="county" data-value="Prince George's"><a href="#">Prince George's County</a></li>

      
    <li role="separator" class="divider"></li>
    
    <li data-geo="city"><a href="#">Silver Spring</a></li>
    <li data-geo="city"><a href="#">Bethesda</a></li>
    <li data-geo="city"><a href="#">Langley Park</a></li>
    <li data-geo="city"><a href="#">New Carrollton</a></li>

    </ul>
</div>
</div>

<div class="expand-map">
	<a onclick="expandMap();" class="btn btn-primary">
		Larger <span class="glyphicon glyphicon-chevron-down"></span> Map</a></div>

<div id="textContent">
	
<div><h3>Mapping Gentrification Risk in the Purple Line Corridor</h3></div>

<div><a href="http://communityinnovation.berkeley.edu/uploads/Table.png" target="_blank"><img class="figure mobile-hide" src="http://communityinnovation.berkeley.edu/uploads/Table.png"></a>

The Purple Line Corridor is at risk for gentrification because x y and z

<br><br>
NCSG compiled a Gentrification Risk index for understanding where displacement is most likely to happen and 
</div>

<div class="larger">
<br><h3>Key Findings</h3>
<ul>
<li>finding one<br></li>
<li>finding two<br></li>
<li>finding three<br></li>
<li>finding four<br></li>
</ul></div>

<div><br><h3>Data and Documentation</h3>
<ul><li><a href="#">Methodology &amp; results of the Regional Early Warning System</a> [PDF]</li>
<li><a href="http://communityinnovation.berkeley.edu/uploads/CCI_REWS_data_2015-08-21.xlsx">Download all data series from map</a> [XLS]</li></ul>
</div>

<div><br><h3>Additional Resources from NCSG's Gentrification Risk Study and the Purple Line Corridor Coalition</h3>
<ul>
<li>Methodology</li>
<li>Data</li>
<li>Other</li>
</ul>
</div>

<div class="smaller">
<br><h4>Notes</h4>
<ul><li>Data sources include the U.S. Census, American Community Survey (ACS), Maryland Quarterly Census of Employment and Wages (QCEW), and Longitudinal Employment Household Dynamics (LEHD). Please see our downloadable data table above for more details. 
</li></ul></div>

<div><br><br></div>
    
    </div>

<script>

// set the initial map options and url here
var INITIAL_MAP_SETTINGS = {
	detectRetina: true,
	center_lat: 39,
	center_lon: -77,
	zoom: 11
}
var INITIAL_VISJSON_URL = $('#layer-selector .active').data('url');

// state variables
var activeVis = null;
var baseQuery = null; // default for layer
var activeQuery = null; // geo selection if any
var activeCityName = null;
var activeCityOutline = null;

function getVisLayer() {
	// returns the CartoDB visualization layer
	var layers = activeVis.getLayers();
	return layers[1].getSubLayer(0);
}

function setUpMap(visjsonURL, mapSettings) {
	$("#mapContainer").append("<div id='map'></div>");
	cartodb.createVis('map', visjsonURL, mapSettings)
		.done(function(vis, layers) {
			activeVis = vis;
			// save default sql query and apply county selection if needed
			baseQuery = getVisLayer().getSQL();
			// replicate prior geo selection
			if (activeQuery) getVisLayer().setSQL(activeQuery);
			if (activeCityName) addCityOutline(activeCityName);
			// set custom text for search box, and remove when user clicks
			var textBox = $("#map .cartodb-searchbox .text");
			var defaultTxt = 'Go to place';
			textBox.val(defaultTxt);
			textBox.click(function() { 
				if ($(this).val() == defaultTxt) $(this).val(''); 
			});
		});
}

$('#layer-selector li').click(function() {
	var url = $(this).data('url');
	var lmap = activeVis.getNativeMap();
	var activeMapSettings = {
		detectRetina: true,
		center_lat: lmap.getCenter().lat,
		center_lon: lmap.getCenter().lng,
		zoom: lmap.getZoom()
	}
	activeVis.remove();
	setUpMap(url, activeMapSettings);
	resetMenu($(this));
});

$('#geo-selector li').click(function() {
	clearCityOutline();
	var geo = $(this).data('geo'); // 'city' or 'county' or 'all'
	var selection = $(this).text(); // name of drop-down item
	var query = baseQuery;
	if (geo == 'county') {
		var value = $(this).data('value');
		query += " WHERE _county = '" + value + "'";
	}
	// San Fran county data includes Farallon Islands; map looks better if we select city instead
	if (selection == 'San Francisco County') {
		query = baseQuery + " WHERE _city = 'San Francisco'";
	}
	if (geo == 'city') {
		query += " WHERE _city = '" + selection + "'";
		addCityOutline(selection);
	}
	if (geo != 'all') 
		zoomToExtent(query);
		
    // apply the query and save it in case the layer is changed
    getVisLayer().setSQL(query);
	activeQuery = query;
	resetMenu($(this));
});

function zoomToExtent(query) {
	var sql = new cartodb.SQL({user: 'cci-displacement'});  // this needs to be changed to Nick's username, but doing so now (while there is no SQL associated with his account) will break the map so leaving as-is for now
	sql.getBounds(query).done(function(bounds) {
        activeVis.getNativeMap().fitBounds(bounds);
    });
}

function addCityOutline(name) {
	activeCityName = name;
	activeCityOutline = activeVis.getLayers()[1].createSubLayer({
		sql: "SELECT * FROM bay_area_places_clean_v2 WHERE name = '" + name + "'",
		cartocss: '#bay_area_places_clean_v2 { line-color: #000; line-width: 1.5;}'
	});
}

function clearCityOutline() {
	if (activeCityOutline) activeCityOutline.remove();
	activeCityName = null;
	activeCityOutline = null;
}

function resetMenu(obj) {
	// reset selection in a pulldown menu
	obj.parent().find('.active').removeClass('active');
	obj.addClass('active');
}

function expandMap() {
	$(window).scrollTop($("#mapContainer").position().top - 15);
	var h = $(window).height() - 75;
	$("#mapContainer").height(h);
	$(".expand-map").html('<a onclick="contractMap();" class="btn btn-primary">Smaller <span class="glyphicon glyphicon-chevron-up"></span> Map');
}

function contractMap() {
	$(window).scrollTop(0);
	$("#mapContainer").height(450);
	$(".expand-map").html('<a onclick="expandMap();" class="btn btn-primary">Larger <span class="glyphicon glyphicon-chevron-down"></span> Map');
}

window.onload = function() {
	setUpMap(INITIAL_VISJSON_URL, INITIAL_MAP_SETTINGS);
}

</script>

</body>
</html>
